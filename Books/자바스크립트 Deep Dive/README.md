# Web Rendering



#### 브라우저 기본구조와 기능

- 사용자가 선택한 자원을 서버에 요청, 브라우저에 표시

- 자원은 html문서, pdf, image 등 다양한 형태, 자원의 주소는 url에 의해 정해짐

- 브라우저는 html과 css 명세에 따라 html 파일을 해석해서 표시함( 이 명세는 웹 표준화 기구에서 정해짐 )



- **브라우저 기본구조**

<img src = "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2FRjPWd%2FbtqFvJeCwUT%2FPS21y0Nn3kQQ5bP0yLcx81%2Fimg.png" />

1. 사용자 인터페이스

   주소표시줄, 이전/다음 버튼, 북마크 등 사용자가 활용하는 서비스들( 요청하는 페이지를 보여주는 창을 제외한 나머지 부분)

2. 브라우저엔진

   사용자 인터페이스와 렌더링 엔진 사이의 동작제어

3. 렌더링 엔진

   요청한 콘텐츠 표시( html 요청이 들어오면 - > html, css 파싱해서 화면에 표시 )

4. 통신

   http 요청과 같은 네트워크 호출에 사용 (플랫폼의 독립적인 인터페이스로 구성)

5. UI백엔드

   플랫폼에 명시하지 않은 일반적인 인터페이스, 콤보 박스 창 같은 기본적 장치를 그림

6. 자바스크립트 해석기

   자바스크립트 코드를 해석하고 실행

7. 자료저장소

   쿠키 등 모든 종류의 자원을 하드 디스크에 저장하는 계층



### Rendering 이란?

**렌더링엔진은 요청 받은 내용을 브라우저 화면에 표시해준다**

기본적으로 html, xml 문서와 이미지를 표시할 수 있다. 

- 렌더링 엔진 종류
  1. 크롬, 사파리 : Webkit(웹킷) 엔진 사용
  2. 파이어폭스 : Gecko(게코) 엔진 사용



**렌더링 동작과정**

<img src= "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2FbSfcnr%2FbtqFAgIHbN8%2FO9uMHMWfRiq4FJ3sK3MBzk%2Fimg.png" />

```
먼저 html 문서를 파싱한다.
그리고 콘텐츠 트리 내부에서 태그를 모두 DOM 노드로 변환한다.
그 다음 외부 css 파일과 함께 포함된 스타일 요소도 변환한다.
이 스타일 정보와 html 표시 규칙은 렌더트리라고 부르는 또 다른 트리를 생성한다.

이렇게 생성된 렌더트리는 정해진 순서대로 화면에 표시되는데, 생성 과정이 끝났을 때 배치가 진행되면서 노드가 화면의 정확한 위치에 표시되는 것을 의미한다.

이후에 UI 백앤드에서 렌더 트리의 각 노드를 가로지르며 형상을 만드는 그리기 과정이 진행된다.

이러한 과정이 점진적으로 진행되며, 렌더링 과정은 좀더 빠르게 사용자에게 제공하기 위해 모든 html을 
파싱할 때 까지 기다리지 않고 배치와 그리기 과정을 시작한다.

전송을 받고 기다리는 동시에 받은 내용을 먼저 화면에 보여준다.
(우리가 웹페이지에 접속할 때 한꺼번에 뜨지 않고 점점 화면에 나오는 것이 이때문)
```



**DOM이란**



Document Object Model(문서 객체 모델)

웹 페이지 소스를 까보면 <html>, <body>와 같은 태그들이 존재한다. 이를 Javascript가 활용할 수 있는 객체로 만들면 문서 객체가 된다.

모델은 말 그대로, 모듈화로 만들었다거나 객체를 인식한다라고 해석하면 된다.

즉 DOM은 웹브라우저가 html 페이지를 인식하는 방식을 말한다. (트리구조)



<img src ="https://k.kakaocdn.net/dn/byGVo6/btqw5gYDZ0A/eZeDv0AZ2V2sjm18Ijl1G0/img.png" />



**CSS트리**



<img src ="https://k.kakaocdn.net/dn/Dpw1V/btqw2AKyscP/ip6ekvhztkOtFWkXMsoa51/img.png"/>



**Render Tree 생성**

DOM Tree와 CSSOM Tree가 만들어졌으면 그 다음으로는 이 둘을 이용하여 Render Tree를 생성합니다. 순수한 요소들의 구조와 텍스트만 존재하는 DOM Tree와는 달리 Render Tree에는 **스타일 정보가 설정**되어 있으며 **실제 화면에 표현되는 노드들로만 구성**됩니다.



<img src = "https://k.kakaocdn.net/dn/lph3J/btqw55WR4Wn/552yhvux3qRnjWJeshq5wK/img.png" />

그러면 여기서 각 요소에 스타일 정보들이 설정되어 있는건 이해할 수 있겠는데 실제 화면에 표현되는 노드들로만 구성된다는 이야기에 **"모든 요소는 다 화면에 표현되는거 아닌가?"** 라는 의문을 가지실 것 같습니다.

 

결론을 말하면 네, 아닙니다. 간단한 예로 display: none 속성이 설정된 노드는 화면에 어떠한 공간도 차지하지 않기 때문에 Render Tree를 만드는 과정에서 제외됩니다. 여기서 조금만 더 팁을 드리자면 visibility: invisible 은 display: none과 비슷하게 동작하지만, 공간은 차지하고 요소가 보이지 않게만 하기 때문에 Render Tree에 포함됩니다.

 

**3. Layout**

Layout 단계는 브라우저의 뷰포트(Viewport) 내에서 각 노드들의 정확한 위치와 크기를 계산합니다. 풀어서 얘기하자면 생성된 Render Tree 노드들이 가지고 있는 스타일과 속성에 따라서 **브라우저 화면의 어느위치에 어느크기로 출력될지 계산하는 단계**라고 할 수 있습니다. Layout 단계를 통해 %, vh, vw와 같이 상대적인 위치, 크기 속성은 실제 화면에 그려지는 pixel단위로 변환됩니다.

 



![img](https://k.kakaocdn.net/dn/QcxqS/btqw7cJlNLe/BYjU4ozlpBPYZWQbLCJz50/img.png)

Viewport 에 상대적인 요소 연산



여기서 **뷰포트(Viewport)**란 그래픽이 표시되는 브라우저의 영역, 크기를 말합니다. 뷰포트는 모바일의 경우 디스플레이의 크기, PC의 경우 브라우저 창의 크기에 따라 달라집니다. 그리고 화면에 그려지는 각 요소들의 크기와 위치는 %, vh, vw와 같이 상대적으로 계산하여 그려지는 경우가 많기 때문에 viewport 크기가 달라질 경우 매번 계산을 다시해야 합니다.



**4. Paint**

Layout 계산이 완료되면 이제 요소들을 실제 화면을 그리게 됩니다. 이전 단계에서 이미 요소들의 위치와 크기, 스타일 계산이 완료된 Render Tree 를 이용해 실제 픽셀 값을 채워넣게 됩니다. 이 때 텍스트, 색, 이미지, 그림자 효과등이 모두 처리되어 그려집니다.

 

이 때 처리해야 하는 스타일이 복잡할수록 Paint 단계에 소요되는 시간이 늘어나게 됩니다. 간단한 예시로 단순한 단색 background-color의 경우 paint 속도가 빠르지만 그라데이션이나 그림자 효과등은 painting 소요시간이 비교적 더 오래 소요됩니다.



출처: https://boxfoxs.tistory.com/408 [박스여우 - BoxFox]



**웹킷 동작 구조**

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fk.kakaocdn.net%2Fdn%2FqJx25%2FbtqFztPOaG3%2FPtgvVOgxUwB7dcOkyIlTZk%2Fimg.png" />

*어테치먼트* : 웹킷이 렌더 트리를 생성하기 위해 DOM 노드와  스타일 정보를 연결하는 과정



**파싱(parsing)**

문서 파싱은 브라우저가 코드를 이해하고 사용할 수 있는 구조로 변환하는 것

문서를 가지고, 어휘 분석과 구문 분석 과정을 거쳐 파싱 트리를 구축한다.

어휘 분석기를 통해 언어의 구문 규칙에 따라 문서 구조를 분석한다. 이 과정에서 구문 규칙과 일치하는지 비교하고, 일치하는 노드만 파싱 트리에 추가시킨다. (끝까지 규칙이 맞지 않는 부분은 문서가 유효하지 않고 구문 오류가 포함 되어 있는 것)



##### 요약

1.  주소창에 url을 입력하고 Enter를 누르면, 서버에 요청이 전송됨
2.  해당 페이지에 존재하는 여러 자원들(image, text 등등)이 보내짐
3.  이제 브라우저는 해당 자원이 담긴 html과 스타일이 담긴 css를 W3C 명세에 따라 해석할 것임
4.  이 역활을 하는 것이 렌더링엔진
5.  렌더링 엔진은 우선 html 파싱 과정을 시작하고, 파서가 문서에 존재하는 어휘와 구문을 분석해 DOM트리를 구축함
6.  다음에 CSS 파싱 과정 시작 css파서가 모든 css 정보를 스타일 구조체로 생성
7.  이 두가지를 연결시켜 렌더 트리를 만듬, 렌더 트리를 통해 문서가 시각적 요소를 포함한 형태로 구성된 상태
8.  화면에 배치를 시작하고 UI 백앤드가 노드를 돌면서 형상을 그림
9.  이때 빠른 브라우저 화면 표시를 위해 '배치와 그리는 과정'은 페이지  정보를 모두 받고 한꺼번에 진행되지 않음, 자원을 전송 받으면, 기다리는 동시에 일부분 먼저 진행하고 화면에 표시함.
